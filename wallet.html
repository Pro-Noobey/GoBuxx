<!DOCTYPE html>
<html>
<head>
    <title>Go Buxx Wallet</title>
    <link rel="stylesheet" href="style.css">
    <script>
        const savedTheme = localStorage.getItem('theme') || 'dark';
        if (savedTheme === 'light') {
            document.documentElement.classList.add('light-mode');
        }
    </script>
</head>
<body class="dark-mode">
    <header class="main-header">
        <div class="user-info">
            <a href="account.html" class="menu-link">&#x2190; Back</a>
        </div>
        <h1>Wallet</h1>
        <p>Your current balance: ♦<span id="balance">...</span></p>
    </header>

    <section class="form-section" id="send-money-section">
        <h2>Send Money</h2>
        <form id="transferForm" class="form">
            <input type="text" id="recipient" placeholder="Recipient Username" required>
            <input type="number" id="amount" placeholder="Amount (♦)" min="1" required>
            <button type="submit">Send Funds</button>
            <p id="message" style="color: var(--accent-color); margin-top: 15px;"></p>
        </form>
    </section>
    
    <section class="history-section">
        <h2>Transaction History</h2>
        
        <div class="transaction-list" id="transactionList">
            <p id="loadingMsg">Loading transactions...</p>
        </div>
        
    </section>

    <script>
    const API_URL = 'https://lieselotte-pestersome-wenona.ngrok-free.dev'; // REMEMBER TO UPDATE THIS IF YOUR TUNNEL CHANGES!

    document.addEventListener('DOMContentLoaded', () => {
        // Apply theme for the body
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.body.classList.remove('dark-mode', 'light-mode');
        document.body.classList.add(`${savedTheme}-mode`);
        
        const username = localStorage.getItem('username');
        
        // AUTHENTICATION CHECK
        if (!username || username === "undefined" || username === "null") {
            window.location.href = 'login.html';
            return;
        }

        const balanceSpan = document.getElementById('balance');
        const form = document.getElementById('transferForm');
        const message = document.getElementById('message');
        const transactionList = document.getElementById('transactionList');

        // Function to create a beautifully styled transaction item
        const createTransactionItem = (tx) => {
            const item = document.createElement('div');
            item.className = `transaction-item ${tx.type}`;

            let contextUser;
            let amountSign;
            
            // Determine the context user and sign based on the type
            if (tx.type === 'sent') {
                contextUser = tx.recipient;
                amountSign = '-';
            } else { // received
                contextUser = tx.sender;
                amountSign = '+';
            }

            // Format the timestamp to be cleaner (e.g., "Oct 3, 2025")
            // Note: This assumes the 'timestamp' field from main.py is in a standard format.
            const date = new Date(tx.timestamp);
            const formattedDate = date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });


            item.innerHTML = `
                <div class="tx-details">
                    <span class="tx-amount">${amountSign}♦${tx.amount}</span>
                    <span class="tx-context">${contextUser}</span>
                </div>
                <span class="tx-date">${formattedDate}</span>
            `;
            return item;
        };

        // Function to fetch and display the transaction history
        const fetchHistory = async () => {
            transactionList.innerHTML = '<p id="loadingMsg" style="text-align: center;">Loading transactions...</p>';
            try {
                const res = await fetch(`${API_URL}/get_transactions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                const data = await res.json();

                transactionList.innerHTML = ''; // Clear loading message

                if (data.history && data.history.length > 0) {
                    data.history.forEach(tx => {
                        transactionList.appendChild(createTransactionItem(tx));
                    });
                } else {
                    transactionList.innerHTML = '<p style="text-align: center; color: #888;">No transactions found.</p>';
                }

            } catch (err) {
                transactionList.innerHTML = '<p style="text-align: center; color: #ff6666;">Failed to load history (Check server/tunnel).</p>';
            }
        };

        // Function to update the balance displayed on the page
        const updateBalance = async () => {
            try {
                const res = await fetch(`${API_URL}/get_account_data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                const data = await res.json();
                if (!data.error) {
                    balanceSpan.textContent = data.balance;
                }
            } catch (err) {
                console.error("Failed to fetch balance:", err);
                balanceSpan.textContent = 'Error';
            }
        };

        // Load initial data
        updateBalance();
        fetchHistory();

        // TRANSFER MONEY LOGIC
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const recipient = document.getElementById('recipient').value;
            const amount = parseInt(document.getElementById('amount').value);
            
            message.textContent = '';

            try {
                const res = await fetch(`${API_URL}/transfer_money`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        sender: username, 
                        recipient: recipient, 
                        amount: amount 
                    })
                });

                const result = await res.json();
                if (result.success) {
                    message.textContent = `Success! ${result.message}`;
                    balanceSpan.textContent = result.new_balance;
                    form.reset();
                    // CRITICAL: Reload history after a successful transaction!
                    fetchHistory(); 
                } else {
                    message.textContent = `Transfer Failed: ${result.message}`;
                }
            } catch (err) {
                message.textContent = 'A network error occurred during the transfer.';
            }
        });
    });
    </script>
</body>
</html>
